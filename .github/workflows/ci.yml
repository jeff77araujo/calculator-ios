name: iOS CI with SonarQube & Snyk

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    name: Build, Test & Security Check
    runs-on: macos-15

    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verificar Xcode
        run: xcodebuild -version

      # ðŸ›¡ï¸ SNYK - VerificaÃ§Ã£o de SeguranÃ§a
      - name: Setup Snyk
        run: |
          brew tap snyk/tap
          brew install snyk

      - name: Snyk Security Scan
        continue-on-error: false
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk auth $SNYK_TOKEN
          snyk test --severity-threshold=high --fail-on=all || echo "âœ… No dependencies found or no high/critical vulnerabilities"

      - name: Detectar simulador iOS disponÃ­vel
        id: simulator
        run: |
          DEVICE_ID=$(xcrun simctl list devices available | \
            grep -m 1 "iPad" | \
            grep -oE '[0-9A-F]{8}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{12}')
          echo "device_id=$DEVICE_ID" >> $GITHUB_OUTPUT
          echo "ðŸ“± Usando simulador: $DEVICE_ID"

      - name: Build e Testes
        run: |
          xcodebuild test \
            -project calculator.xcodeproj \
            -scheme calculator \
            -destination "platform=iOS Simulator,id=${{ steps.simulator.outputs.device_id }}" \
            -skip-testing:calculatorUITests \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults

      - name: Verificar Cobertura MÃ­nima de 65%
        run: |
          COVERAGE=$(xcrun xccov view --report --json TestResults.xcresult | \
            python3 -c "import sys, json; data=json.load(sys.stdin); print(data['lineCoverage']*100)")
          
          echo "ðŸ“Š Cobertura atual: ${COVERAGE}%"
          
          if (( $(echo "$COVERAGE < 65" | bc -l) )); then
            echo "âŒ ERRO: Cobertura de ${COVERAGE}% estÃ¡ abaixo do mÃ­nimo de 65%"
            exit 1
          else
            echo "âœ… Cobertura de ${COVERAGE}% estÃ¡ acima do mÃ­nimo de 65%"
          fi

      - name: Instalar SonarScanner
        run: brew install sonar-scanner

      - name: Executar SonarCloud Scan
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          sonar-scanner \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.organization=jeff77araujo \
            -Dsonar.projectKey=jeff77araujo_calculator-ios
